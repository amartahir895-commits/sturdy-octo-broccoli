const os = require('os')
const axios = require('axios')

// ===== GLOBAL THUMB INDEX =====
let thumbIndex = 0

// ===== UPTIME FORMAT =====
function formatUptime(ms) {
  let totalMinutes = Math.floor(ms / 60000)
  let days = Math.floor(totalMinutes / (60 * 24))
  let hours = Math.floor((totalMinutes % (60 * 24)) / 60)
  let minutes = totalMinutes % 60
  
  // Fancy style with symbols
  return `â³ ${days} ğ•• ${hours} ğ•™ ${minutes} ğ•`
}

// ===== FAKE QUOTED MESSAGE =====
const fakeQuoted = {
  key: {
    fromMe: false,
    participant: "0@s.whatsapp.net",
    remoteJid: "status@broadcast"
  },
  message: {
    orderMessage: {
      orderId: "2009",
      thumbnail: null,
      itemCount: "9999",
      status: "INQUIRY",
      surface: "",
      message: `âœ¦ â¤ÍŸÍŸÍÍ ğ•±ğ–†ğ–’ ğ–”ğ–‹ğ–ˆ â›§`,
      token: "AR6xBKbXZn0Xwmu76Ksyd7rnxI+Rx87HfinVlW4lwXa6JA=="
    }
  },
  contextInfo: {
    mentionedJid: ["120363390114292114@s.whatsapp.net"],
    forwardingScore: 999,
    isForwarded: true,
  }
};

const handler = async (m, { conn, usedPrefix, user }) => {
  // ===== USER DATA =====
  const exp = user?.exp ?? 0
  const limit = user?.limit ?? 0
  const money = user?.money ?? 0
  const premium = user?.premium ? 'Yes âœ…' : 'No âŒ'

  // ===== UPTIME =====
  const botUptime = formatUptime(process.uptime() * 1000)
  const vpsUptime = formatUptime(os.uptime() * 1000)

  // ===== MULTIPLE THUMBNAILS =====
  const images = [

    'https://files.catbox.moe/iu9h16.jpg',
    'https://files.catbox.moe/u8dvn3.jpg',
        'https://files.catbox.moe/rr4s0u.jpg',
    'https://files.catbox.moe/baxynu.jpg',
  ]

  // Ek image select karo (rotate karega har baar)
  const selectedImage = images[thumbIndex]
  thumbIndex = (thumbIndex + 1) % images.length

  // ===== CONFIG =====
  const footer = 'Â© 2025 FAM OFC'
  const botFullName = 'FAM OFC BOT'
  const chShort = 'https://whatsapp.com/channel/0029Vb2pMIt1NCrUCy9Q0f3C'
  const idCh = '120363390114292114@newsletter'

  // ===== MENU TEXT =====
  let menuText = `
âœ¦ *${botFullName}*

â•­â”€â§‰ *USER INFO* â§‰â”€â•®
â”‚ âœ¿ ğ”¼ğ•©ğ•¡ : ${exp}
â”‚ âœ¿ ğ•ƒğ•šğ•ğ•šğ•¥ : ${limit}
â”‚ âœ¿ ğ•„ğ• ğ•Ÿğ•–ğ•ª : ${money}
â”‚ âœ¿ â„™ğ•£ğ•–ğ•ğ•šğ•¦ğ• : ${premium}
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â§‰ *BOT INFO* â§‰â”€â•®
â”‚ âœ¿ ğ•„ğ• ğ••ğ•– : ğ•¡ğ•¦ğ•“ğ•ğ•šğ•”
â”‚ âœ¿ ğ”¹ğ• ğ•¥ ğ•Œğ•¡ğ•¥ğ•šğ•ğ•– : ${botUptime}
â”‚ âœ¿ ğ•â„™ğ•Š ğ•Œğ•¡ğ•¥ğ•šğ•ğ•– : ${vpsUptime}
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â¤
`

  // ===== COMMAND CATEGORIES =====
  let categories = {}
  for (let plugin of global.plugins) {
    let cat = plugin.category || 'Main Menu'
    if (!categories[cat]) categories[cat] = []
    categories[cat].push(plugin)
  }

  for (let [cat, cmds] of Object.entries(categories)) {
    menuText += `â”‚â•­â”€â–£ã€Œ ${cat.toUpperCase()} ã€â–£â”€â•®\n`
    for (let cmd of cmds) {
      if (!cmd.command) continue
      for (let c of cmd.command) {
        menuText += `â”‚â”‚ âŸ¿ ${usedPrefix}${c}\n`
      }
    }
    menuText += `â”‚â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ”‚\n`
  }

  menuText += `
â”‚â•­==âŠ± *ğ•ğ•ª ğ•—ğ•£ğ•šğ•–ğ•Ÿğ••ğ•¤* â–£â”€â•®
â”‚â”‚â†» ğ•Œğ•¤ğ•ğ•’ğ•Ÿ ğ•¡ğ•’ğ•¤ğ•™ğ•’
â”‚â”‚â†» ğ•ğ•šğ•œğ•š ğ•”ğ•ªğ•“ğ•–ğ•£ ğ•–ğ•©ğ•¡ğ• ğ•£ğ•¥ 
â”‚â”‚â†» â„™ğ•£ğ• ğ•—ğ•–ğ•¤ğ•¤ğ• ğ•£ ğ”¸ğ•ğ•ğ•’ğ•£
â”‚â”‚â†» â„ğ•šğ•¤ğ•™ğ•š ğ•¥ğ•–ğ•’ğ• ğŸğŸ
â”‚â”‚â†» â„•ğ•’ğ••ğ•–ğ•£ ğ•ğ••
â”‚â•°â”€â”€â”€â¤
â”‚
â”‚â•­==âŠ± *ğ•†ğ•—ğ•—ğ•šğ•”ğ•šğ•’ğ• ğ•Šğ• ğ•¦ğ•£ğ•”ğ•–* â–£â”€â•®
â”‚â”‚â†» ğ•ğ•–ğ•“ğ•¤ğ•šğ•¥ğ•–: https://famofc.site
â”‚â•°â”€â”€â”€â¤
â•°â”€â”€â”€â”€â”€â”ˆâ¤

${footer}
`

  // ===== DOWNLOAD IMAGE =====
  const downloadImage = async (url) => {
    try {
      const res = await axios.get(url, { responseType: 'arraybuffer' })
      return Buffer.from(res.data)
    } catch {
      return null
    }
  }

  const imageBuffer = await downloadImage(selectedImage)
  
  // ===== IMAGE MESSAGE =====
  const imageMessage = {
    image: imageBuffer,
    caption: menuText.trim(),
    footer: footer,
    contextInfo: {
      forwardingScore: 999,
      isForwarded: true,
      externalAdReply: {
        body: `â° ğ•Œğ•¡ğ•¥ğ•šğ•ğ•–: ${botUptime}`,
        thumbnailUrl: selectedImage,
        thumbnail: imageBuffer,
        mediaType: 1,
        renderLargerThumbnail: true,
        mediaUrl: chShort,
      },
      forwardedNewsletterMessageInfo: {
        newsletterJid: idCh,
        newsletterName: footer,
      },
    },
  }

  // Send message with fake quoted
  await conn.sendMessage(m.chat, imageMessage, { quoted: fakeQuoted })
}

handler.command = ['allmenu', 'menu', 'help']
handler.category = 'tools'
handler.limit = false

module.exports = handler